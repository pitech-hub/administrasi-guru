<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - MTs Negeri 1 Lamongan (Google Sheets)</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
      /* CSS tetap sama seperti sebelumnya */
      :root {
        --primary: #2563eb;
        --primary-dark: #1e40af;
        --secondary: #64748b;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --info: #3b82f6;
        --bg-body: #f1f5f9;
        --bg-card: #ffffff;
        --text-main: #0f172a;
        --text-muted: #64748b;
        --radius: 12px;
        --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        --transition: all 0.2s ease-in-out;
        --sidebar-width: 260px;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
      }
      body {
        background-color: var(--bg-body);
        color: var(--text-main);
        display: flex;
        min-height: 100vh;
        overflow-x: hidden;
      }

      /* --- Sidebar & Layout --- */
      .sidebar {
        width: var(--sidebar-width);
        background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
        color: white;
        position: fixed;
        height: 100vh;
        left: 0;
        top: 0;
        z-index: 50;
        display: flex;
        flex-direction: column;
        transition: var(--transition);
      }
      .sidebar-brand {
        height: 70px;
        display: flex;
        align-items: center;
        padding: 0 25px;
        font-size: 1.1rem;
        font-weight: 700;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .sidebar-brand i {
        margin-right: 12px;
        color: var(--primary);
      }
      .nav-menu {
        list-style: none;
        padding: 20px 10px;
        flex-grow: 1;
        overflow-y: auto;
      }
      .nav-link {
        display: flex;
        align-items: center;
        padding: 12px 20px;
        color: #94a3b8;
        text-decoration: none;
        border-radius: var(--radius);
        transition: var(--transition);
        font-weight: 500;
        cursor: pointer;
        margin-bottom: 5px;
      }
      .nav-link i {
        width: 25px;
        text-align: center;
        margin-right: 10px;
      }
      .nav-link:hover,
      .nav-link.active {
        background-color: rgba(255, 255, 255, 0.05);
        color: white;
        border-left: 4px solid var(--primary);
      }

      .main-wrapper {
        margin-left: var(--sidebar-width);
        width: calc(100% - var(--sidebar-width));
        transition: var(--transition);
        display: flex;
        flex-direction: column;
      }
      .topbar {
        height: 70px;
        background: var(--bg-card);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 30px;
        box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        position: sticky;
        top: 0;
        z-index: 40;
        flex-shrink: 0;
      }
      .content {
        padding: 30px;
        flex-grow: 1;
      }

      /* --- Components --- */
      .page-section {
        display: none;
        animation: fadeIn 0.3s ease;
      }
      .page-section.active {
        display: block;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .data-card {
        background: var(--bg-card);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 25px;
        border: 1px solid #e2e8f0;
        margin-bottom: 20px;
      }
      .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 1px solid #f1f5f9;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        border: none;
        cursor: pointer;
        transition: var(--transition);
      }
      .btn-primary {
        background: var(--primary);
        color: white;
      }
      .btn-success {
        background: var(--success);
        color: white;
      }
      .btn-danger {
        background: var(--danger);
        color: white;
        padding: 6px 12px;
        font-size: 0.8rem;
      }
      .btn-info {
        background: var(--info);
        color: white;
      }
      .btn-outline {
        background: transparent;
        border: 1px solid #cbd5e1;
        color: var(--text-main);
      }

      .form-control,
      .form-select {
        padding: 10px 15px;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        outline: none;
        transition: var(--transition);
        width: 100%;
      }
      .form-control:focus,
      .form-select:focus {
        border-color: var(--primary);
      }

      .table-responsive {
        overflow-x: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px;
      }
      th,
      td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #f1f5f9;
      }
      th {
        color: var(--text-muted);
        font-size: 0.85rem;
        text-transform: uppercase;
        background: #f8fafc;
      }

      .badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
      }
      .badge-L {
        background: #dbeafe;
        color: var(--primary);
      }
      .badge-P {
        background: #fce7f3;
        color: #db2777;
      }

      /* Modal */
      .modal-overlay {
        display: none;
        position: fixed;
        z-index: 100;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(4px);
        align-items: center;
        justify-content: center;
      }
      .modal-overlay.open {
        display: flex;
      }
      .modal-box {
        background: white;
        width: 500px;
        max-width: 90%;
        padding: 30px;
        border-radius: var(--radius);
        animation: slideUp 0.3s ease;
      }
      @keyframes slideUp {
        from {
          transform: translateY(20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .form-group {
        margin-bottom: 15px;
      }
      .form-label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        font-size: 0.9rem;
      }

      /* Grid Nilai - TAMBAHAN CSS */
      .grid-nilai {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 10px;
      }
      .grid-nilai label {
        display: block;
        font-size: 0.8rem;
        margin-bottom: 2px;
        color: var(--text-muted);
      }

      .toast-container {
        position: fixed;
        bottom: 25px;
        right: 25px;
        z-index: 200;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .toast {
        min-width: 300px;
        padding: 15px 20px;
        border-radius: 8px;
        background: white;
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        border-left: 5px solid;
        display: flex;
        align-items: center;
        justify-content: space-between;
        animation: slideLeft 0.3s ease;
      }
      .toast.success {
        border-color: var(--success);
      }
      .toast.error {
        border-color: var(--danger);
      }
      @keyframes slideLeft {
        from {
          transform: translateX(100%);
        }
        to {
          transform: translateX(0);
        }
      }

      /* Responsive */
      @media (max-width: 992px) {
        .sidebar {
          transform: translateX(-100%);
        }
        .sidebar.active {
          transform: translateX(0);
        }
        .main-wrapper {
          margin-left: 0;
          width: 100%;
        }
      }
      .toggle-btn {
        display: none;
        cursor: pointer;
        font-size: 1.2rem;
      }
      @media (max-width: 992px) {
        .toggle-btn {
          display: block;
        }
      }

      /* Tambahkan CSS ini di dalam tag <style> */
      .sidebar-overlay {
        display: none; /* Sembunyikan secara default */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5); /* Latar belakang gelap transparan */
        z-index: 49; /* Di bawah sidebar (z-index 50), tapi di atas konten */
        backdrop-filter: blur(2px);
      }

      .sidebar-overlay.active {
        display: block; /* Muncul saat menu dibuka */
      }
      /* Style untuk tombol saat di-disabled */
      .btn:disabled {
        background-color: #cbd5e1; /* Warna abu-abu */
        color: #64748b;
        cursor: not-allowed; /* Kursor silang */
        pointer-events: none; /* Tidak bisa diklik */
      }

      /* Animasi putar untuk icon loading */
      .fa-spin {
        animation: fa-spin 2s infinite linear;
      }
      @keyframes fa-spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* TAMBAHKAN CSS INI AGAR KOTAK STATISTIK TAMPIL RAPI */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid #e2e8f0;
      }

      .stat-info h3 {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 5px;
      }
      .stat-info p {
        margin: 0;
        color: var(--text-muted);
        font-size: 0.85rem;
      }

      .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
      }

      /* Warna Latar Belakang Icon */
      .bg-green-light {
        background: #dcfce7;
        color: var(--success);
      }
      .bg-orange-light {
        background: #ffedd5;
        color: var(--warning);
      }
      .bg-blue-light {
        background: #dbeafe;
        color: var(--info);
      }
      .bg-red-light {
        background: #fee2e2;
        color: var(--danger);
      }
    </style>
  </head>
  <body>
    <div
      id="sidebar-overlay"
      class="sidebar-overlay"
      onclick="toggleSidebar()"
    ></div>
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-brand">
        <i class="fas fa-school"></i> MTsN 1 Lamongan
      </div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="#" class="nav-link active" onclick="nav('dashboard', this)"
            ><i class="fas fa-home"></i> Dashboard</a
          >
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" onclick="nav('data-guru', this)"
            ><i class="fas fa-chalkboard-teacher"></i> Data Guru</a
          >
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" onclick="nav('data-siswa', this)"
            ><i class="fas fa-user-graduate"></i> Data Siswa</a
          >
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" onclick="nav('jurnal', this)">
            <i class="fas fa-book-open"></i> Jurnal Mengajar
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" onclick="nav('absensi', this)">
            <i class="fas fa-clipboard-check"></i> Daftar Hadir
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" onclick="nav('nilai', this)"
            ><i class="fas fa-star"></i> Nilai Siswa</a
          >
        </li>
      </ul>
    </aside>

    <div class="main-wrapper">
      <header class="topbar">
        <div style="display: flex; align-items: center">
          <i class="fas fa-bars toggle-btn" onclick="toggleSidebar()"></i>
          <h3
            style="font-size: 1.2rem; font-weight: 600; margin-left: 15px"
            id="page-title"
          >
            Dashboard
          </h3>
        </div>
        <div
          class="user-profile"
          style="display: flex; align-items: center; gap: 10px"
        >
          <span>Admin</span>
          <img
            src="logo.jpg"
            class="avatar"
            style="width: 40px; height: 40px; border-radius: 50%"
          />
        </div>
      </header>

      <main class="content">
        <!-- DASHBOARD -->
        <section id="dashboard" class="page-section active">
          <div class="data-card">
            <h4>Selamat Datang</h4>
            <p>Sistem terhubung ke Google Sheets sebagai database utama.</p>
            <br />
            <button class="btn btn-primary" onclick="fetchDataFromSheets()">
              <i class="fas fa-sync"></i> Refresh Data dari Sheets
            </button>
          </div>
        </section>

        <!-- DATA GURU (No HP Removed) -->
        <section id="data-guru" class="page-section">
          <div class="data-card">
            <div class="toolbar">
              <div class="toolbar-left">
                <button
                  class="btn btn-primary"
                  onclick="openModal('modal-guru')"
                >
                  <i class="fas fa-plus"></i> Tambah Guru
                </button>

                <!-- TOMBOL UPLOAD EXCEL GURU -->
                <input
                  type="file"
                  id="upload-guru"
                  accept=".xlsx, .xls"
                  style="display: none"
                  onchange="handleBulkUpload(this, 'guru')"
                />
                <button
                  class="btn btn-success"
                  onclick="document.getElementById('upload-guru').click()"
                >
                  <i class="fas fa-file-excel"></i> Upload Excel
                </button>
              </div>
              <button class="btn btn-outline" onclick="exportToExcel('guru')">
                <i class="fas fa-download"></i> Download Excel
              </button>
            </div>
            <div class="table-responsive">
              <table id="table-guru">
                <thead>
                  <tr>
                    <th>NIP</th>
                    <th>Nama Lengkap</th>
                    <th>Mata Pelajaran</th>
                    <th style="text-align: right">Aksi</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="4" style="text-align: center">
                      Memuat data...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- DATA SISWA -->
        <section id="data-siswa" class="page-section">
          <div class="data-card">
            <div class="toolbar">
              <div class="toolbar-left">
                <button
                  class="btn btn-primary"
                  onclick="openModal('modal-siswa')"
                >
                  <i class="fas fa-plus"></i> Tambah Siswa
                </button>

                <!-- TOMBOL UPLOAD EXCEL SISWA -->
                <input
                  type="file"
                  id="upload-siswa"
                  accept=".xlsx, .xls"
                  style="display: none"
                  onchange="handleBulkUpload(this, 'siswa')"
                />
                <button
                  class="btn btn-success"
                  onclick="document.getElementById('upload-siswa').click()"
                >
                  <i class="fas fa-file-excel"></i> Upload Excel
                </button>
              </div>
              <button class="btn btn-outline" onclick="exportToExcel('siswa')">
                <i class="fas fa-download"></i> Download Excel
              </button>
            </div>
            <div class="table-responsive">
              <table id="table-siswa">
                <thead>
                  <tr>
                    <th>NISN</th>
                    <th>Nama Lengkap</th>
                    <th>Kelas</th>
                    <th>L/P</th>
                    <th style="text-align: right">Aksi</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="5" style="text-align: center">
                      Memuat data...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- 4. JURNAL MENGAJAR -->
        <section id="jurnal" class="page-section">
          <div class="data-card">
            <div class="toolbar">
              <div
                class="toolbar-left"
                style="
                  display: flex;
                  flex-wrap: wrap;
                  gap: 10px;
                  align-items: center;
                  flex-grow: 1;
                "
              >
                <button class="btn btn-primary" onclick="openModalJurnal()">
                  <i class="fas fa-plus"></i> Tambah
                </button>

                <!-- FILTERS -->
                <select
                  id="filter-guru"
                  class="form-select"
                  onchange="renderJurnalTable()"
                  style="width: 150px"
                >
                  <option value="">Semua Guru</option>
                </select>

                <select
                  id="filter-mapel"
                  class="form-select"
                  onchange="renderJurnalTable()"
                  style="width: 150px"
                >
                  <option value="">Semua Mapel</option>
                  <option value="Al-Qur'an">Al-Qur'an</option>
                  <option value="Akidah">Akidah</option>
                  <option value="Fikih">Fikih</option>
                  <option value="SKI">SKI</option>
                  <option value="Matematika">Matematika</option>
                  <option value="Bahasa Arab">Bahasa Arab</option>
                  <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                  <option value="Bahasa Inggris">Bahasa Inggris</option>
                  <option value="Bahasa Inggris">Bahasa Jawa</option>
                  <option value="IPA">Ilmu Pengetahuan Alam (IPA)</option>
                  <option value="IPS">Ilmu Pengetahuan Sosial (IPS)</option>
                  <option value="PKN">PKN</option>
                  <option value="Seni Budaya/Prakarya">
                    Seni Budaya/Prakarya
                  </option>
                  <option value="PJOK">PJOK</option>
                  <option value="Informatika">Informatika</option>
                </select>

                <select
                  id="filter-kelas"
                  class="form-select"
                  onchange="renderJurnalTable()"
                  style="width: 150px"
                >
                  <option value="">Semua Kelas</option>
                  <option value="7A">7A</option>
                  <option value="7B">7B</option>
                  <option value="7C">7C</option>
                  <option value="7D">7D</option>
                  <option value="7E">7E</option>
                  <option value="7F">7F</option>
                  <option value="7G">7G</option>
                  <option value="7H">7H</option>
                  <option value="7I">7I</option>
                  <option value="7J">7J</option>
                  <option value="7K">7K</option>
                  <option value="7L">7L</option>
                  <option value="7M">7M</option>
                  <option value="7N">7N</option>
                  <option value="7O">7O</option>
                  <option value="7P">7P</option>
                  <option disabled>---</option>
                  <option value="8A">8A</option>
                  <option value="8B">8B</option>
                  <option value="8C">8C</option>
                  <option value="8D">8D</option>
                  <option value="8E">8E</option>
                  <option value="8F">8F</option>
                  <option value="8G">8G</option>
                  <option value="8H">8H</option>
                  <option value="8I">8I</option>
                  <option value="8J">8J</option>
                  <option value="8K">8K</option>
                  <option value="8L">8L</option>
                  <option value="8M">8M</option>
                  <option value="8N">8N</option>
                  <option value="8O">8O</option>
                  <option value="8P">8P</option>
                  <option disabled>---</option>
                  <option value="9A">9A</option>
                  <option value="9B">9B</option>
                  <option value="9C">9C</option>
                  <option value="9D">9D</option>
                  <option value="9E">9E</option>
                  <option value="9F">9F</option>
                  <option value="9G">9G</option>
                  <option value="9H">9H</option>
                  <option value="9I">9I</option>
                  <option value="9J">9J</option>
                  <option value="9K">9K</option>
                  <option value="9L">9L</option>
                  <option value="9M">9M</option>
                  <option value="9N">9N</option>
                  <option value="9O">9O</option>
                  <option value="9P">9P</option>
                </select>

                <input
                  type="month"
                  id="filter-bulan"
                  class="form-control"
                  onchange="renderJurnalTable()"
                  style="width: 160px"
                />
              </div>

              <div class="toolbar-right">
                <button class="btn btn-outline" onclick="exportJurnalToExcel()">
                  <i class="fas fa-file-excel"></i> Download Excel
                </button>
              </div>
            </div>

            <div class="table-responsive">
              <table id="table-jurnal">
                <thead>
                  <tr>
                    <th width="10%">Tanggal</th>
                    <!-- Lebar diperlebar sedikit agar teks '1 - 3' muat rapi -->
                    <th width="12%">Jam Ke-</th>
                    <th>Guru</th>
                    <th width="10%">Kelas/Mapel</th>
                    <th>Kegiatan</th>
                    <th width="15%">Penugasan</th>
                    <th width="15%">Absensi</th>
                    <th style="text-align: right">Aksi</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="8" style="text-align: center">
                      Memuat data...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- MODAL JURNAL (POP UP) -->
        <div
          id="modal-jurnal"
          class="modal-overlay"
          onclick="if(event.target === this) closeModalJurnal()"
        >
          <div class="modal-box">
            <div class="modal-header">
              <h3 class="modal-title" id="modal-jurnal-title">
                Tambah Jurnal Mengajar
              </h3>
            </div>
            <br />
            <form id="form-jurnal" onsubmit="saveJurnal(event)">
              <input type="hidden" id="jurnal-id" />

              <div class="form-group">
                <label class="form-label">Nama Guru</label>
                <select id="jurnal-guru" class="form-select" required>
                  <option value="">-- Pilih Guru --</option>
                </select>
              </div>

              <!-- GRID DIUBAH: Menjadi 2 Kolom untuk lebih rapi -->
              <!-- Baris 1: Kelas & Mapel -->
              <div
                style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px"
              >
                <div class="form-group">
                  <label class="form-label">Kelas</label>
                  <select id="jurnal-kelas" class="form-select" required>
                    <option value="7A">7A</option>
                    <option value="7B">7B</option>
                    <option value="7C">7C</option>
                    <option value="7D">7D</option>
                    <option value="7E">7E</option>
                    <option value="7F">7F</option>
                    <option value="7G">7G</option>
                    <option value="7H">7H</option>
                    <option value="7I">7I</option>
                    <option value="7J">7J</option>
                    <option value="7K">7K</option>
                    <option value="7L">7L</option>
                    <option value="7M">7M</option>
                    <option value="7N">7N</option>
                    <option value="7O">7O</option>
                    <option value="7P">7P</option>
                    <option disabled>---</option>
                    <option value="8A">8A</option>
                    <option value="8B">8B</option>
                    <option value="8C">8C</option>
                    <option value="8D">8D</option>
                    <option value="8E">8E</option>
                    <option value="8F">8F</option>
                    <option value="8G">8G</option>
                    <option value="8H">8H</option>
                    <option value="8I">8I</option>
                    <option value="8J">8J</option>
                    <option value="8K">8K</option>
                    <option value="8L">8L</option>
                    <option value="8M">8M</option>
                    <option value="8N">8N</option>
                    <option value="8O">8O</option>
                    <option value="8P">8P</option>
                    <option disabled>---</option>
                    <option value="9A">9A</option>
                    <option value="9B">9B</option>
                    <option value="9C">9C</option>
                    <option value="9D">9D</option>
                    <option value="9E">9E</option>
                    <option value="9F">9F</option>
                    <option value="9G">9G</option>
                    <option value="9H">9H</option>
                    <option value="9I">9I</option>
                    <option value="9J">9J</option>
                    <option value="9K">9K</option>
                    <option value="9L">9L</option>
                    <option value="9M">9M</option>
                    <option value="9N">9N</option>
                    <option value="9O">9O</option>
                    <option value="9P">9P</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Mapel</label>
                  <select id="jurnal-mapel" class="form-select" required>
                    <option value="">-- Pilih Mapel --</option>
                    <option value="Al-Qur'an">Al-Qur'an</option>
                    <option value="Akidah">Akidah</option>
                    <option value="Fikih">Fikih</option>
                    <option value="SKI">SKI</option>
                    <option value="Matematika">Matematika</option>
                    <option value="Bahasa Arab">Bahasa Arab</option>
                    <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                    <option value="Bahasa Inggris">Bahasa Inggris</option>
                    <option value="Bahasa Jawa">Bahasa Jawa</option>
                    <option value="IPA">Ilmu Pengetahuan Alam (IPA)</option>
                    <option value="IPS">Ilmu Pengetahuan Sosial (IPS)</option>
                    <option value="PKN">PKN</option>
                    <option value="Seni Budaya/Prakarya">
                      Seni Budaya/Prakarya
                    </option>
                    <option value="PJOK">PJOK</option>
                    <option value="Informatika">Informatika</option>
                  </select>
                </div>
              </div>

              <!-- Baris 2: Jam Mulai & Jam Sampai (BARU) -->
              <div
                style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px"
              >
                <div class="form-group">
                  <label class="form-label">Mulai Jam Ke-</label>
                  <select id="jurnal-jamke-mulai" class="form-select" required>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Sampai Jam Ke-</label>
                  <select id="jurnal-jamke-sampai" class="form-select" required>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Tanggal</label>
                <input
                  type="date"
                  id="jurnal-tanggal"
                  class="form-control"
                  required
                />
              </div>

              <div class="form-group">
                <label class="form-label">Kegiatan / Materi</label>
                <textarea
                  id="jurnal-materi"
                  class="form-control"
                  rows="3"
                  required
                  placeholder="Ringkasan materi..."
                ></textarea>
              </div>

              <div class="form-group">
                <label class="form-label">Penugasan</label>
                <textarea
                  id="jurnal-tugas"
                  class="form-control"
                  rows="2"
                  placeholder="Deskripsi tugas..."
                ></textarea>
              </div>

              <div class="form-group">
                <label class="form-label">Siswa Tidak Hadir (Nama & Ket)</label>
                <input
                  type="text"
                  id="jurnal-absensi"
                  class="form-control"
                  placeholder="Contoh: Ahmad (S), Budi (I)"
                />
              </div>

              <button type="submit" class="btn btn-primary" style="width: 100%">
                Simpan Data
              </button>
            </form>
          </div>
        </div>

        <!-- 5. DAFTAR HADIR SISWA -->
        <section id="absensi" class="page-section">
          <!-- FORM INPUT PRESENSI -->
          <div class="data-card">
            <div class="toolbar">
              <h4>Input Presensi Kelas</h4>
              <button class="btn btn-primary" onclick="loadPresensiForm()">
                <i class="fas fa-sync"></i> Tampilkan Siswa
              </button>
            </div>

            <!-- Area Pilihan Kelas & Tanggal -->
            <div
              style="
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 15px;
                margin-bottom: 20px;
              "
            >
              <div class="form-group">
                <label class="form-label">Kelas</label>
                <select id="absen-kelas" class="form-select">
                  <option value="">-- Pilih Kelas --</option>
                  <option value="7A">7A</option>
                  <option value="7B">7B</option>
                  <option value="7C">7C</option>
                  <option value="7D">7D</option>
                  <option value="7E">7E</option>
                  <option value="7F">7F</option>
                  <option value="7G">7G</option>
                  <option value="7H">7H</option>
                  <option value="7I">7I</option>
                  <option value="7J">7J</option>
                  <option value="7K">7K</option>
                  <option value="7L">7L</option>
                  <option value="7M">7M</option>
                  <option value="7N">7N</option>
                  <option value="7O">7O</option>
                  <option value="7P">7P</option>
                  <option disabled>---</option>
                  <option value="8A">8A</option>
                  <option value="8B">8B</option>
                  <option value="8C">8C</option>
                  <option value="8D">8D</option>
                  <option value="8E">8E</option>
                  <option value="8F">8F</option>
                  <option value="8G">8G</option>
                  <option value="8H">8H</option>
                  <option value="8I">8I</option>
                  <option value="8J">8J</option>
                  <option value="8K">8K</option>
                  <option value="8L">8L</option>
                  <option value="8M">8M</option>
                  <option value="8N">8N</option>
                  <option value="8O">8O</option>
                  <option value="8P">8P</option>
                  <option disabled>---</option>
                  <option value="9A">9A</option>
                  <option value="9B">9B</option>
                  <option value="9C">9C</option>
                  <option value="9D">9D</option>
                  <option value="9E">9E</option>
                  <option value="9F">9F</option>
                  <option value="9G">9G</option>
                  <option value="9H">9H</option>
                  <option value="9I">9I</option>
                  <option value="9J">9J</option>
                  <option value="9K">9K</option>
                  <option value="9L">9L</option>
                  <option value="9M">9M</option>
                  <option value="9N">9N</option>
                  <option value="9O">9O</option>
                  <option value="9P">9P</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Mata Pelajaran</label>
                <!-- PERUBAHAN: INPUT TEXT JADI DROPDOWN -->
                <select id="absen-mapel" class="form-select">
                  <option value="">-- Pilih Mapel --</option>
                  <option value="Al-Qur'an">Al-Qur'an</option>
                  <option value="Akidah">Akidah</option>
                  <option value="Fikih">Fikih</option>
                  <option value="SKI">SKI</option>
                  <option value="Matematika">Matematika</option>
                  <option value="Bahasa Arab">Bahasa Arab</option>
                  <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                  <option value="Bahasa Inggris">Bahasa Inggris</option>
                  <option value="Bahasa Inggris">Bahasa Jawa</option>
                  <option value="IPA">Ilmu Pengetahuan Alam (IPA)</option>
                  <option value="IPS">Ilmu Pengetahuan Sosial (IPS)</option>
                  <option value="PKN">PKN</option>
                  <option value="Seni Budaya/Prakarya">
                    Seni Budaya/Prakarya
                  </option>
                  <option value="PJOK">PJOK</option>
                  <option value="Informatika">Informatika</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Tanggal</label>
                <input type="date" id="absen-tanggal" class="form-control" />
              </div>
            </div>

            <div id="absen-input-container" class="table-responsive">
              <div
                style="
                  padding: 40px;
                  text-align: center;
                  color: var(--text-muted);
                  border: 2px dashed #e2e8f0;
                  border-radius: 8px;
                "
              >
                Silahkan pilih Kelas dan klik "Tampilkan Siswa"
              </div>
            </div>
          </div>

          <!-- REKAP KEHADIRAN (Sebelumnya Riwayat) -->
          <div class="data-card">
            <div class="toolbar">
              <div
                class="toolbar-left"
                style="
                  display: flex;
                  gap: 10px;
                  flex-wrap: wrap;
                  align-items: center;
                "
              >
                <h4>Rekap Kehadiran</h4>

                <!-- FILTERS -->
                <select
                  id="rekap-kelas"
                  class="form-select"
                  onchange="renderPresensiTable()"
                  style="width: 150px"
                >
                  <option value="">Semua Kelas</option>
                  <option value="7A">7A</option>
                  <option value="7B">7B</option>
                  <option value="7C">7C</option>
                  <option value="7D">7D</option>
                  <option value="7E">7E</option>
                  <option value="7F">7F</option>
                  <option value="7G">7G</option>
                  <option value="7H">7H</option>
                  <option value="7I">7I</option>
                  <option value="7J">7J</option>
                  <option value="7K">7K</option>
                  <option value="7L">7L</option>
                  <option value="7M">7M</option>
                  <option value="7N">7N</option>
                  <option value="7O">7O</option>
                  <option value="7P">7P</option>
                  <option disabled>---</option>
                  <option value="8A">8A</option>
                  <option value="8B">8B</option>
                  <option value="8C">8C</option>
                  <option value="8D">8D</option>
                  <option value="8E">8E</option>
                  <option value="8F">8F</option>
                  <option value="8G">8G</option>
                  <option value="8H">8H</option>
                  <option value="8I">8I</option>
                  <option value="8J">8J</option>
                  <option value="8K">8K</option>
                  <option value="8L">8L</option>
                  <option value="8M">8M</option>
                  <option value="8N">8N</option>
                  <option value="8O">8O</option>
                  <option value="8P">8P</option>
                  <option disabled>---</option>
                  <option value="9A">9A</option>
                  <option value="9B">9B</option>
                  <option value="9C">9C</option>
                  <option value="9D">9D</option>
                  <option value="9E">9E</option>
                  <option value="9F">9F</option>
                  <option value="9G">9G</option>
                  <option value="9H">9H</option>
                  <option value="9I">9I</option>
                  <option value="9J">9J</option>
                  <option value="9K">9K</option>
                  <option value="9L">9L</option>
                  <option value="9M">9M</option>
                  <option value="9N">9N</option>
                  <option value="9O">9O</option>
                  <option value="9P">9P</option>
                </select>

                <select
                  id="rekap-mapel"
                  class="form-select"
                  onchange="renderPresensiTable()"
                  style="width: 150px"
                >
                  <option value="">Semua Mapel</option>
                  <option value="Al-Qur'an">Al-Qur'an</option>
                  <option value="Akidah">Akidah</option>
                  <option value="Fikih">Fikih</option>
                  <option value="SKI">SKI</option>
                  <option value="Matematika">Matematika</option>
                  <option value="Bahasa Arab">Bahasa Arab</option>
                  <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                  <option value="Bahasa Inggris">Bahasa Inggris</option>
                  <option value="Bahasa Inggris">Bahasa Jawa</option>
                  <option value="IPA">Ilmu Pengetahuan Alam (IPA)</option>
                  <option value="IPS">Ilmu Pengetahuan Sosial (IPS)</option>
                  <option value="PKN">PKN</option>
                  <option value="Seni Budaya/Prakarya">
                    Seni Budaya/Prakarya
                  </option>
                  <option value="PJOK">PJOK</option>
                  <option value="Informatika">Informatika</option>
                </select>

                <input
                  type="month"
                  id="rekap-bulan"
                  class="form-control"
                  onchange="renderPresensiTable()"
                  style="width: 160px"
                />
              </div>

              <div class="toolbar-right">
                <button
                  class="btn btn-outline"
                  onclick="downloadPresensiToExcel()"
                >
                  <i class="fas fa-file-excel"></i> Download Excel
                </button>
              </div>
            </div>

            <div class="table-responsive">
              <!-- TAMBAHKAN INI: Wadah untuk Kartu Total Hadir/Sakit/dll -->
              <!-- TAMBAHKAN INI: Wadah Kartu Total (Style Sama dengan Dashboard) -->
              <div
                id="rekap-stats"
                class="stats-grid"
                style="display: none; margin-bottom: 25px"
              >
                <!-- Hadir -->
                <div class="stat-card">
                  <div class="stat-info">
                    <h3 id="stat-total-h">0</h3>
                    <p>Total Hadir</p>
                  </div>
                  <div class="stat-icon bg-green-light">
                    <i class="fas fa-check-circle"></i>
                  </div>
                </div>
                <!-- Sakit -->
                <div class="stat-card">
                  <div class="stat-info">
                    <h3 id="stat-total-s">0</h3>
                    <p>Total Sakit</p>
                  </div>
                  <div class="stat-icon bg-orange-light">
                    <i class="fas fa-procedures"></i>
                  </div>
                </div>
                <!-- Izin -->
                <div class="stat-card">
                  <div class="stat-info">
                    <h3 id="stat-total-i">0</h3>
                    <p>Total Izin</p>
                  </div>
                  <div class="stat-icon bg-blue-light">
                    <i class="fas fa-envelope-open-text"></i>
                  </div>
                </div>
                <!-- Alpha -->
                <div class="stat-card">
                  <div class="stat-info">
                    <h3 id="stat-total-a">0</h3>
                    <p>Total Alpha</p>
                  </div>
                  <div class="stat-icon bg-red-light">
                    <i class="fas fa-user-times"></i>
                  </div>
                </div>
              </div>

              <table id="table-presensi">
                <thead>
                  <tr>
                    <th>No</th>
                    <th>Kelas</th>
                    <th>NISN</th>
                    <th>Nama Siswa</th>
                    <th>Hari/Tanggal</th>
                    <th>Mapel</th>
                    <th>Status</th>
                    <th>Persentase</th>
                    <!-- Kolom Baru -->
                    <th style="text-align: right">Aksi</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="9" style="text-align: center">
                      Memuat data...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- NILAI SISWA (MENU BARU) -->
        <section id="nilai" class="page-section">
          <div class="data-card">
            <div class="toolbar">
              <div
                class="toolbar-left"
                style="display: flex; gap: 10px; align-items: center"
              >
                <button class="btn btn-primary" onclick="openModalNilai()">
                  <i class="fas fa-plus"></i> Input Nilai
                </button>

                <select
                  id="filter-nilai-kelas"
                  class="form-select"
                  style="width: 150px"
                  onchange="renderNilaiTable()"
                >
                  <option value="">Semua Kelas</option>
                  <option value="7 A">7A</option>
                  <option value="7 B">7B</option>
                  <option value="7 C">7C</option>
                  <option value="7 D">7D</option>
                  <option value="7 E">7E</option>
                  <option value="7 F">7F</option>
                  <option value="7 G">7G</option>
                  <option value="7 H">7H</option>
                  <option value="7 I">7I</option>
                  <option value="7 J">7J</option>
                  <option value="7 K">7K</option>
                  <option value="7 L">7L</option>
                  <option value="7 M">7M</option>
                  <option value="7 N">7N</option>
                  <option value="7 O">7O</option>
                  <option value="7 P">7P</option>
                  <option disabled>---</option>
                  <option value="8 A">8A</option>
                  <option value="8 B">8B</option>
                  <option value="8 C">8C</option>
                  <option value="8 D">8D</option>
                  <option value="8 E">8E</option>
                  <option value="8 F">8F</option>
                  <option value="8 G">8G</option>
                  <option value="8 H">8H</option>
                  <option value="8 I">8I</option>
                  <option value="8 J">8J</option>
                  <option value="8 K">8K</option>
                  <option value="8 L">8L</option>
                  <option value="8 M">8M</option>
                  <option value="8 N">8N</option>
                  <option value="8 O">8O</option>
                  <option value="8 P">8P</option>
                  <option disabled>---</option>
                  <option value="9 A">9A</option>
                  <option value="9 B">9B</option>
                  <option value="9 C">9C</option>
                  <option value="9 D">9D</option>
                  <option value="9 E">9E</option>
                  <option value="9 F">9F</option>
                  <option value="9 G">9G</option>
                  <option value="9 H">9H</option>
                  <option value="9 I">9I</option>
                  <option value="9 J">9J</option>
                  <option value="9 K">9K</option>
                  <option value="9 L">9L</option>
                  <option value="9 M">9M</option>
                  <option value="9 N">9N</option>
                  <option value="9 O">9O</option>
                  <option value="9 P">9P</option>
                </select>

                <select
                  id="filter-nilai-mapel"
                  class="form-select"
                  style="width: 150px"
                  onchange="renderNilaiTable()"
                >
                  <option value="">Semua Mapel</option>
                  <option value="Al-Qur'an">Al-Qur'an</option>
                  <option value="Akidah">Akidah</option>
                  <option value="Fikih">Fikih</option>
                  <option value="SKI">SKI</option>
                  <option value="Matematika">Matematika</option>
                  <option value="Bahasa Arab">Bahasa Arab</option>
                  <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                  <option value="Bahasa Inggris">Bahasa Inggris</option>
                  <option value="Bahasa Inggris">Bahasa Jawa</option>
                  <option value="IPA">Ilmu Pengetahuan Alam (IPA)</option>
                  <option value="IPS">Ilmu Pengetahuan Sosial (IPS)</option>
                  <option value="PKN">PKN</option>
                  <option value="Seni Budaya/Prakarya">
                    Seni Budaya/Prakarya
                  </option>
                  <option value="PJOK">PJOK</option>
                  <option value="Informatika">Informatika</option>
                </select>
              </div>
              <button class="btn btn-outline" onclick="exportNilaiToExcel()">
                <i class="fas fa-file-excel"></i> Download Excel
              </button>
            </div>

            <div class="table-responsive">
              <table id="table-nilai">
                <thead>
                  <tr>
                    <th style="min-width: 150px">Nama Siswa</th>
                    <th width="80">Kelas</th>
                    <th width="120">Mapel</th>
                    <th width="40">N1</th>
                    <th width="40">N2</th>
                    <th width="40">N3</th>
                    <th width="40">N4</th>
                    <th width="40">N5</th>
                    <th width="40">N6</th>
                    <th width="40">N7</th>
                    <th width="40">N8</th>
                    <th width="40">N9</th>
                    <th width="40">N10</th>
                    <th width="60" style="background: #dbeafe">Rata-rata</th>
                    <th style="text-align: right">Aksi</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="15" style="text-align: center">
                      Memuat data...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- MODAL GURU (No HP) -->
    <div id="modal-guru" class="modal-overlay">
      <div class="modal-box">
        <div
          class="modal-header"
          style="
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
          "
        >
          <h3 id="modal-guru-title">Tambah Guru</h3>
          <button
            class="close-modal"
            onclick="closeModal('modal-guru')"
            style="
              border: none;
              background: none;
              font-size: 1.5rem;
              cursor: pointer;
            "
          >
            &times;
          </button>
        </div>
        <form id="form-guru" onsubmit="saveGuru(event)">
          <input type="hidden" id="guru-id" />
          <div class="form-group">
            <label class="form-label">NIP</label>
            <!-- oninput mencegah input selain angka -->
            <input
              type="text"
              id="guru-nip"
              class="form-control"
              required
              oninput="this.value = this.value.replace(/[^0-9]/g, '')"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Nama Lengkap</label>
            <input type="text" id="guru-nama" class="form-control" required />
          </div>
          <!-- GANTI BAGIAN INPUT MAPEL DI MODAL GURU -->
          <div class="form-group">
            <label class="form-label">Mata Pelajaran</label>
            <select id="guru-mapel" class="form-select" required>
              <option value="">-- Pilih Mapel --</option>
              <option value="Al-Qur'an">Al-Qur'an</option>
              <option value="Akidah">Akidah</option>
              <option value="Fikih">Fikih</option>
              <option value="SKI">SKI</option>
              <option value="Matematika">Matematika</option>
              <option value="Bahasa Arab">Bahasa Arab</option>
              <option value="Bahasa Indonesia">Bahasa Indonesia</option>
              <option value="Bahasa Inggris">Bahasa Inggris</option>
              <option value="Bahasa Inggris">Bahasa Jawa</option>
              <option value="IPA">Ilmu Pengetahuan Alam (IPA)</option>
              <option value="IPS">Ilmu Pengetahuan Sosial (IPS)</option>
              <option value="PKN">PKN</option>
              <option value="Seni Budaya/Prakarya">Seni Budaya/Prakarya</option>
              <option value="PJOK">PJOK</option>
              <option value="Informatika">Informatika</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary" style="width: 100%">
            Simpan Data
          </button>
        </form>
      </div>
    </div>

    <!-- MODAL SISWA -->
    <div id="modal-siswa" class="modal-overlay">
      <div class="modal-box">
        <div
          class="modal-header"
          style="
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
          "
        >
          <h3 id="modal-siswa-title">Tambah Siswa</h3>
          <button
            class="close-modal"
            onclick="closeModal('modal-siswa')"
            style="
              border: none;
              background: none;
              font-size: 1.5rem;
              cursor: pointer;
            "
          >
            &times;
          </button>
        </div>
        <form id="form-siswa" onsubmit="saveSiswa(event)">
          <input type="hidden" id="siswa-id" />
          <div class="form-group">
            <label class="form-label">NISN</label>
            <input
              type="text"
              id="siswa-nisn"
              class="form-control"
              required
              oninput="this.value = this.value.replace(/[^0-9]/g, '')"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Nama Lengkap</label>
            <input type="text" id="siswa-nama" class="form-control" required />
          </div>
          <div class="form-group">
            <label class="form-label">Kelas</label>
            <select id="siswa-kelas" class="form-select">
              <!-- Opsi Kelas dari A sampai P -->
              <option value="7A">7A</option>
              <option value="7B">7B</option>
              <option value="7C">7C</option>
              <option value="7D">7D</option>
              <option value="7E">7E</option>
              <option value="7F">7F</option>
              <option value="7G">7G</option>
              <option value="7H">7H</option>
              <option value="7I">7I</option>
              <option value="7J">7J</option>
              <option value="7K">7K</option>
              <option value="7L">7L</option>
              <option value="7M">7M</option>
              <option value="7N">7N</option>
              <option value="7O">7O</option>
              <option value="7P">7P</option>
              <option disabled>---</option>
              <option value="8A">8A</option>
              <option value="8B">8B</option>
              <option value="8C">8C</option>
              <option value="8D">8D</option>
              <option value="8E">8E</option>
              <option value="8F">8F</option>
              <option value="8G">8G</option>
              <option value="8H">8H</option>
              <option value="8I">8I</option>
              <option value="8J">8J</option>
              <option value="8K">8K</option>
              <option value="8L">8L</option>
              <option value="8M">8M</option>
              <option value="8N">8N</option>
              <option value="8O">8O</option>
              <option value="8P">8P</option>
              <option disabled>---</option>
              <option value="9A">9A</option>
              <option value="9B">9B</option>
              <option value="9C">9C</option>
              <option value="9D">9D</option>
              <option value="9E">9E</option>
              <option value="9F">9F</option>
              <option value="9G">9G</option>
              <option value="9H">9H</option>
              <option value="9I">9I</option>
              <option value="9J">9J</option>
              <option value="9K">9K</option>
              <option value="9L">9L</option>
              <option value="9M">9M</option>
              <option value="9N">9N</option>
              <option value="9O">9O</option>
              <option value="9P">9P</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Jenis Kelamin</label>
            <select id="siswa-jk" class="form-select">
              <option value="L">Laki-laki</option>
              <option value="P">Perempuan</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary" style="width: 100%">
            Simpan Data
          </button>
        </form>
      </div>
    </div>

    <!-- MODAL EDIT PRESENSI -->
    <div
      id="modal-presensi"
      class="modal-overlay"
      onclick="if(event.target === this) closeModal('modal-presensi')"
    >
      <div class="modal-box">
        <div class="modal-header">
          <h3 class="modal-title">Edit Data Presensi</h3>
          <!-- <button class="close-modal" onclick="closeModal('modal-presensi')">
            &times;
          </button> -->
        </div>
        <br />
        <form id="form-presensi" onsubmit="updatePresensi(event)">
          <input type="hidden" id="edit-presensi-id" />
          <div class="form-group">
            <label class="form-label">Nama Siswa</label>
            <input
              type="text"
              id="edit-presensi-nama"
              class="form-control"
              disabled
              style="background: #f1f5f9"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Kelas</label>
            <input
              type="text"
              id="edit-presensi-kelas"
              class="form-control"
              disabled
              style="background: #f1f5f9"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Tanggal</label>
            <input
              type="date"
              id="edit-presensi-tanggal"
              class="form-control"
              required
            />
          </div>
          <div class="form-group">
            <label class="form-label">Mata Pelajaran</label>
            <select id="edit-presensi-mapel" class="form-select" required>
              <option value="">-- Pilih Mapel --</option>
              <option value="Al-Qur'an">Al-Qur'an</option>
              <option value="Akidah">Akidah</option>
              <option value="Fikih">Fikih</option>
              <option value="SKI">SKI</option>
              <option value="Matematika">Matematika</option>
              <option value="Bahasa Arab">Bahasa Arab</option>
              <option value="Bahasa Indonesia">Bahasa Indonesia</option>
              <option value="Bahasa Inggris">Bahasa Inggris</option>
              <option value="Bahasa Inggris">Bahasa Jawa</option>
              <option value="IPA">Ilmu Pengetahuan Alam (IPA)</option>
              <option value="IPS">Ilmu Pengetahuan Sosial (IPS)</option>
              <option value="PKN">PKN</option>
              <option value="Seni Budaya/Prakarya">Seni Budaya/Prakarya</option>
              <option value="PJOK">PJOK</option>
              <option value="Informatika">Informatika</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Status Kehadiran</label>
            <select id="edit-presensi-status" class="form-select" required>
              <option value="H">Hadir</option>
              <option value="S">Sakit</option>
              <option value="I">Izin</option>
              <option value="A">Alpha</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary" style="width: 100%">
            Simpan Perubahan
          </button>
        </form>
      </div>
    </div>

    <!-- MODAL NILAI -->
    <div
      id="modal-nilai"
      class="modal-overlay"
      onclick="if(event.target === this) closeModal('modal-nilai')"
    >
      <!-- GANTI BAGIAN INI DI DALAM MODAL NILAI -->
      <div class="modal-box">
        <div class="modal-header">
          <h3>Input Nilai Siswa</h3>
        </div>
        <br />
        <form id="form-nilai" onsubmit="saveNilai(event)">
          <input type="hidden" id="nilai-id" />

          <!-- PERUBAHAN 1: Dropdown Kelas dipindah ke atas -->
          <div class="form-group">
            <label class="form-label">Kelas</label>
            <select
              id="nilai-kelas"
              class="form-select"
              required
              onchange="filterSiswaByKelas()"
            >
              <option value="">-- Pilih Kelas --</option>
              <option value="7 A">7A</option>
              <option value="7 B">7B</option>
              <option value="7 C">7C</option>
              <option value="7 D">7D</option>
              <option value="7 E">7E</option>
              <option value="7 F">7F</option>
              <option value="7 G">7G</option>
              <option value="7 H">7H</option>
              <option value="7 I">7I</option>
              <option value="7 J">7J</option>
              <option value="7 K">7K</option>
              <option value="7 L">7L</option>
              <option value="7 M">7M</option>
              <option value="7 N">7N</option>
              <option value="7 O">7O</option>
              <option value="7 P">7P</option>
              <option disabled>---</option>
              <option value="8 A">8A</option>
              <option value="8 B">8B</option>
              <option value="8 C">8C</option>
              <option value="8 D">8D</option>
              <option value="8 E">8E</option>
              <option value="8 F">8F</option>
              <option value="8 G">8G</option>
              <option value="8 H">8H</option>
              <option value="8 I">8I</option>
              <option value="8 J">8J</option>
              <option value="8 K">8K</option>
              <option value="8 L">8L</option>
              <option value="8 M">8M</option>
              <option value="8 N">8N</option>
              <option value="8 O">8O</option>
              <option value="8 P">8P</option>
              <option disabled>---</option>
              <option value="9 A">9A</option>
              <option value="9 B">9B</option>
              <option value="9 C">9C</option>
              <option value="9 D">9D</option>
              <option value="9 E">9E</option>
              <option value="9 F">9F</option>
              <option value="9 G">9G</option>
              <option value="9 H">9H</option>
              <option value="9 I">9I</option>
              <option value="9 J">9J</option>
              <option value="9 K">9K</option>
              <option value="9 L">9L</option>
              <option value="9 M">9M</option>
              <option value="9 N">9N</option>
              <option value="9 O">9O</option>
              <option value="9 P">9P</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Nama Siswa</label>
            <!-- onchange="autoFillKelasFromNilai()" dihapus karena kelas sudah dipilih manual -->
            <select id="nilai-nisn" class="form-select" required>
              <option value="">-- Pilih Kelas Terlebih Dahulu --</option>
            </select>
          </div>

          <!-- Sisa form (Mapel, Nilai N1-N10, dll) tetap sama seperti sebelumnya... -->
          <div class="form-group">
            <label class="form-label">Mata Pelajaran</label>
            <select id="nilai-mapel" class="form-select" required>
              <option value="">-- Pilih Mapel --</option>
              <option value="Al-Qur'an">Al-Qur'an</option>
              <option value="Akidah">Akidah</option>
              <option value="Fikih">Fikih</option>
              <option value="SKI">SKI</option>
              <option value="Matematika">Matematika</option>
              <option value="Bahasa Arab">Bahasa Arab</option>
              <option value="Bahasa Indonesia">Bahasa Indonesia</option>
              <option value="Bahasa Inggris">Bahasa Inggris</option>
              <option value="Bahasa Jawa">Bahasa Jawa</option>
              <option value="IPA">Ilmu Pengetahuan Alam (IPA)</option>
              <option value="IPS">Ilmu Pengetahuan Sosial (IPS)</option>
              <option value="PKN">PKN</option>
              <option value="Seni Budaya/Prakarya">Seni Budaya/Prakarya</option>
              <option value="PJOK">PJOK</option>
              <option value="Informatika">Informatika</option>
            </select>
          </div>

          <!-- ... (Lanjutkan grid nilai N1-N10 yang sudah ada) ... -->

          <label
            class="form-label"
            style="
              margin-top: 10px;
              font-weight: bold;
              border-bottom: 1px solid #ddd;
            "
            >Nilai Tugas / UH (N1 - N10)</label
          >

          <div class="grid-nilai" style="margin-top: 10px">
            <div>
              <label>N1</label
              ><input
                type="number"
                id="nilai-n1"
                class="form-control"
                oninput="hitungRataRataModal()"
              />
            </div>
            <div>
              <label>N2</label
              ><input
                type="number"
                id="nilai-n2"
                class="form-control"
                oninput="hitungRataRataModal()"
              />
            </div>
            <div>
              <label>N3</label
              ><input
                type="number"
                id="nilai-n3"
                class="form-control"
                oninput="hitungRataRataModal()"
              />
            </div>
            <div>
              <label>N4</label
              ><input
                type="number"
                id="nilai-n4"
                class="form-control"
                oninput="hitungRataRataModal()"
              />
            </div>
            <div>
              <label>N5</label
              ><input
                type="number"
                id="nilai-n5"
                class="form-control"
                oninput="hitungRataRataModal()"
              />
            </div>
            <div>
              <label>N6</label
              ><input
                type="number"
                id="nilai-n6"
                class="form-control"
                oninput="hitungRataRataModal()"
              />
            </div>
            <div>
              <label>N7</label
              ><input
                type="number"
                id="nilai-n7"
                class="form-control"
                oninput="hitungRataRataModal()"
              />
            </div>
            <div>
              <label>N8</label
              ><input
                type="number"
                id="nilai-n8"
                class="form-control"
                oninput="hitungRataRataModal()"
              />
            </div>
            <div>
              <label>N9</label
              ><input
                type="number"
                id="nilai-n9"
                class="form-control"
                oninput="hitungRataRataModal()"
              />
            </div>
            <div>
              <label>N10</label
              ><input
                type="number"
                id="nilai-n10"
                class="form-control"
                oninput="hitungRataRataModal()"
              />
            </div>
          </div>

          <div
            style="
              margin-top: 15px;
              background: #eff6ff;
              padding: 10px;
              border-radius: 8px;
              text-align: center;
            "
          >
            <span style="font-size: 0.9rem; color: var(--text-muted)"
              >Rata-rata Sementara:</span
            >
            <strong
              id="nilai-rata-display"
              style="font-size: 1.2rem; color: var(--primary)"
              >0</strong
            >
          </div>

          <button
            type="submit"
            class="btn btn-primary"
            style="width: 100%; margin-top: 20px"
          >
            Simpan Data
          </button>
        </form>
      </div>
    </div>

    <div class="toast-container" id="toast-area"></div>

    <script>
      // ==========================================
      // KONFIGURASI GOOGLE SHEETS
      // ==========================================
      // GANTI URL DI BAWAH INI DENGAN URL WEB APP DARI LANGKAH 2
      const SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbzt2Kug5Pt4cpSfyfL-M2rdhzlroszpiLzEWTsnem4yVd4f3VHQdKGLUHVsqpgIImfZ/exec";
      // ==========================================

      let dataGuru = [];
      let dataSiswa = [];
      let dataJurnal = [];
      let dataPresensi = [];
      let dataNilai = [];

      // --- FUNGSI UMUM UI ---
      function toggleSidebar() {
        // Toggle Class pada Sidebar
        document.getElementById("sidebar").classList.toggle("active");
        // Toggle Class pada Overlay (PENTING)
        document.getElementById("sidebar-overlay").classList.toggle("active");
      }

      function nav(sectionId, el) {
        // ... kode lama ...
        document
          .querySelectorAll(".page-section")
          .forEach((s) => s.classList.remove("active"));
        document.getElementById(sectionId).classList.add("active");
        document
          .querySelectorAll(".nav-link")
          .forEach((l) => l.classList.remove("active"));
        if (el) el.classList.add("active");
        document.getElementById("page-title").innerText = el
          ? el.innerText.trim()
          : "Dashboard";

        // UPDATE: Otomatis tutup sidebar di layar kecil saat menu diklik
        if (window.innerWidth <= 992) {
          const sidebar = document.getElementById("sidebar");
          const overlay = document.getElementById("sidebar-overlay");

          // Jika sedang terbuka, tutup
          if (sidebar.classList.contains("active")) {
            sidebar.classList.remove("active");
            overlay.classList.remove("active");
          }
        }
      }

      function openModal(id) {
        document.getElementById(id).classList.add("open");
        if (id === "modal-guru") {
          document.getElementById("form-guru").reset();
          document.getElementById("guru-id").value = "";
          document.getElementById("modal-guru-title").innerText = "Tambah Guru";
        }
        if (id === "modal-siswa") {
          document.getElementById("form-siswa").reset();
          document.getElementById("siswa-id").value = "";
          document.getElementById("modal-siswa-title").innerText =
            "Tambah Siswa";
        }
      }
      function closeModal(id) {
        document.getElementById(id).classList.remove("open");
      }

      function showToast(msg, type = "success") {
        const container = document.getElementById("toast-area");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.innerHTML = `<span>${msg}</span> <i class="fas ${
          type === "success" ? "fa-check-circle" : "fa-exclamation-circle"
        }"></i>`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }

      // --- KONEKSI KE GOOGLE SHEETS ---
      async function fetchDataFromSheets() {
        if (!SCRIPT_URL || SCRIPT_URL.includes("PASTE_URL")) {
          alert("Harap isi SCRIPT_URL...");
          return;
        }

        showToast("Mengambil data...", "info");

        try {
          // Ambil Data Guru
          const resGuru = await fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify({ action: "read", type: "guru" }),
          });
          const jsonGuru = await resGuru.json();
          if (jsonGuru.status === "success") {
            dataGuru = jsonGuru.data;
            renderGuruTable();

            // --- PERBAIKAN: Isi Dropdown Filter Guru Sekarang Juga ---
            const filterGuru = document.getElementById("filter-guru");
            if (filterGuru) {
              // Simpan nilai yang sedang dipilih (jika sedang filter)
              const currentVal = filterGuru.value;

              filterGuru.innerHTML = '<option value="">Semua Guru</option>';
              dataGuru.forEach((g) => {
                filterGuru.innerHTML += `<option value="${g.nama}">${g.nama}</option>`;
              });

              // Kembalikan nilai filter jika ada
              filterGuru.value = currentVal;
            }
          }

          // Ambil Data Siswa
          const resSiswa = await fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify({ action: "read", type: "siswa" }),
          });
          const jsonSiswa = await resSiswa.json();
          if (jsonSiswa.status === "success") dataSiswa = jsonSiswa.data;
          renderSiswaTable();

          // Ambil Data Jurnal
          const resJurnal = await fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify({ action: "read", type: "jurnal" }),
          });
          const jsonJurnal = await resJurnal.json();
          if (jsonJurnal.status === "success") dataJurnal = jsonJurnal.data;
          renderJurnalTable();

          // TAMBAHKAN INI: Ambil Data Presensi
          const resPresensi = await fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify({ action: "read", type: "presensi" }),
          });
          const jsonPresensi = await resPresensi.json();
          if (jsonPresensi.status === "success")
            dataPresensi = jsonPresensi.data;
          renderPresensiTable();

          // Fetch Nilai (FIXED: Ini yang kurang tadi)
          const resNilai = await fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify({ action: "read", type: "nilai" }),
          });
          const jsonNilai = await resNilai.json();
          if (jsonNilai.status === "success") {
            dataNilai = jsonNilai.data;
            renderNilaiTable();
          }

          showToast("Sinkronisasi Selesai");
        } catch (error) {
          console.error(error);
          showToast("Gagal koneksi ke Google Sheets", "error");
        }
      }

      async function sendDataToSheets(action, type, payload) {
        try {
          const res = await fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify({ action: action, type: type, data: payload }),
          });
          return await res.json();
        } catch (error) {
          console.error(error);
          return { status: "error", message: error.toString() };
        }
      }

      // --- LOGIKA GURU ---
      function renderGuruTable() {
        const tbody = document.querySelector("#table-guru tbody");
        tbody.innerHTML = "";
        dataGuru.forEach((g) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
          <td>${g.nip}</td>
          <td><strong>${g.nama}</strong></td>
          <td><span class="badge badge-L">${g.mapel}</span></td>
          <td style="text-align: right;">
            <button class="btn btn-info" onclick="editGuru(${g.id})"><i class="fas fa-edit"></i></button>
            <button class="btn btn-danger" onclick="deleteGuru(${g.id})"><i class="fas fa-trash"></i></button>
          </td>`;
          tbody.appendChild(tr);
        });
      }

      async function saveGuru(e) {
        e.preventDefault();

        // AMBIL ELEMEN TOMBOL
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML; // Simpan teks asli tombol

        const id = document.getElementById("guru-id").value;
        const nip = document.getElementById("guru-nip").value;
        const nama = document.getElementById("guru-nama").value;
        const mapel = document.getElementById("guru-mapel").value;

        // Validasi input dropdown
        if (!mapel) {
          showToast("Pilih Mata Pelajaran", "error");
          return;
        }

        // 1. Disable tombol & Ganti jadi Loading
        submitBtn.disabled = true;
        submitBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Memproses...';

        let finalId = id;
        if (!finalId) {
          const maxId =
            dataGuru.length > 0
              ? Math.max(...dataGuru.map((d) => Number(d.id)))
              : 0;
          finalId = maxId + 1;
        }

        const payload = { id: finalId, nip, nama, mapel };
        const action = id ? "edit" : "add";

        try {
          const res = await sendDataToSheets(action, "guru", payload);

          if (res.status === "success") {
            showToast(id ? "Data Guru diperbarui" : "Data Guru ditambahkan");
            closeModal("modal-guru");
            fetchDataFromSheets();
          } else {
            showToast("Gagal: " + res.message, "error");
          }
        } catch (error) {
          console.error(error);
          showToast("Terjadi kesalahan koneksi", "error");
        } finally {
          // 2. Aktifkan kembali tombol setelah selesai (sukses maupun gagal)
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalBtnText;
        }
      }

      function editGuru(id) {
        const g = dataGuru.find((d) => d.id == id);
        if (g) {
          document.getElementById("guru-id").value = g.id;
          document.getElementById("guru-nip").value = g.nip;
          document.getElementById("guru-nama").value = g.nama;

          // Set nilai untuk dropdown mapel
          const mapelSelect = document.getElementById("guru-mapel");
          mapelSelect.value = g.mapel;

          document.getElementById("modal-guru-title").innerText = "Edit Guru";
          openModal("modal-guru");
        }
      }
      async function deleteGuru(id) {
        if (confirm("Yakin hapus data ini?")) {
          const res = await sendDataToSheets("delete", "guru", { id });
          if (res.status === "success") {
            showToast("Data dihapus");
            fetchDataFromSheets();
          }
        }
      }

      // --- LOGIKA SISWA ---
      function renderSiswaTable() {
        const tbody = document.querySelector("#table-siswa tbody");
        tbody.innerHTML = "";

        dataSiswa.forEach((s) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
      <td>${s.nisn}</td> <!-- Pakai nisn -->
      <td><strong>${s.nama}</strong></td>
      <td><span class="badge badge-L">${s.kelas}</span></td>
      <td><span class="badge ${s.jk === "L" ? "badge-L" : "badge-P"}">${
            s.jk
          }</span></td>
      <td style="text-align: right;">
        <button class="btn btn-info" onclick="editSiswa(${
          s.id
        })"><i class="fas fa-edit"></i></button>
        <button class="btn btn-danger" onclick="deleteSiswa(${
          s.id
        })"><i class="fas fa-trash"></i></button>
      </td>`;
          tbody.appendChild(tr);
        });
      }

      async function saveSiswa(e) {
        e.preventDefault();

        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;

        // Ganti 'siswa-nis' menjadi 'siswa-nisn'
        const id = document.getElementById("siswa-id").value;
        const nisn = document.getElementById("siswa-nisn").value;
        const nama = document.getElementById("siswa-nama").value;
        const kelas = document.getElementById("siswa-kelas").value;
        const jk = document.getElementById("siswa-jk").value;

        // Validasi Angka (Double check di sisi JS)
        if (isNaN(nisn) || nisn === "") {
          showToast("NISN harus berupa angka!", "error");
          return;
        }

        submitBtn.disabled = true;
        submitBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Memproses...';

        let finalId = id;
        if (!finalId) {
          const maxId =
            dataSiswa.length > 0
              ? Math.max(...dataSiswa.map((d) => Number(d.id)))
              : 0;
          finalId = maxId + 1;
        }

        // Payload mengirim 'nisn'
        const payload = { id: finalId, nisn, nama, kelas, jk };
        const action = id ? "edit" : "add";

        try {
          const res = await sendDataToSheets(action, "siswa", payload);

          if (res.status === "success") {
            showToast(id ? "Data Siswa diperbarui" : "Data Siswa ditambahkan");
            closeModal("modal-siswa");
            fetchDataFromSheets();
          } else {
            showToast("Gagal: " + res.message, "error");
          }
        } catch (error) {
          console.error(error);
          showToast("Terjadi kesalahan koneksi", "error");
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalBtnText;
        }
      }

      function editSiswa(id) {
        const s = dataSiswa.find((d) => d.id == id);
        if (s) {
          document.getElementById("siswa-id").value = s.id;
          document.getElementById("siswa-nisn").value = s.nisn; // Pakai nisn
          document.getElementById("siswa-nama").value = s.nama;
          document.getElementById("siswa-kelas").value = s.kelas;
          document.getElementById("siswa-jk").value = s.jk;
          document.getElementById("modal-siswa-title").innerText = "Edit Siswa";
          openModal("modal-siswa");
        }
      }

      async function deleteSiswa(id) {
        if (confirm("Yakin hapus data ini?")) {
          const res = await sendDataToSheets("delete", "siswa", { id });
          if (res.status === "success") {
            showToast("Data dihapus");
            fetchDataFromSheets();
          }
        }
      }

      // --- EXCEL EXPORT ---
      function exportToExcel(type) {
        let data = [];
        let fileName = "";
        if (type === "guru") {
          data = dataGuru.map((d) => ({
            NIP: d.nip,
            "Nama Lengkap": d.nama,
            "Mata Pelajaran": d.mapel,
          }));
          fileName = "Daftar_Guru_MTsN1Lamongan.xlsx";
        } else if (type === "siswa") {
          data = dataSiswa.map((d) => ({
            NISN: d.nisn,
            "Nama Lengkap": d.nama,
            Kelas: d.kelas,
            "L/P": d.jk,
          }));
          fileName = "Daftar_Siswa_MTsN1Lamongan.xlsx";
        }
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Data");
        XLSX.writeFile(wb, fileName);
      }

      // --- FUNGSI UPLOAD BULK EXCEL ---
      async function handleBulkUpload(input, type) {
        const file = input.files[0];
        if (!file) return;

        showToast("Membaca file Excel...", "info");

        const reader = new FileReader();
        reader.onload = async function (e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);

            if (jsonData.length === 0) {
              showToast("File Excel kosong atau format salah.", "error");
              return;
            }

            // Ambil data yang ada saat ini untuk cek duplikat
            const currentData = type === "guru" ? dataGuru : dataSiswa;
            const newData = [];

            // Tentukan ID terakhir untuk generasi ID baru otomatis
            let maxId = 0;
            if (currentData.length > 0) {
              maxId = Math.max(...currentData.map((d) => Number(d.id)));
            }

            let skippedCount = 0;

            jsonData.forEach((row) => {
              // Mapping Kolom Excel (Case Insensitive & Alias Support)
              const nip = row["NIP"] || row["nip"];
              const nisn = row["NISN"] || row["nisn"];
              const nama = row["Nama Lengkap"] || row["Nama"] || row["nama"];
              const mapel = row["Mata Pelajaran"] || row["mapel"] || "-";
              const kelas = row["Kelas"] || row["kelas"] || "-";
              const jk = row["L/P"] || row["jk"] || row["Jenis Kelamin"] || "L";

              // Validasi wajib ada
              const uniqueKey = type === "guru" ? nip : nisn;

              if (!nama || !uniqueKey) return; // Skip jika data tidak lengkap

              // Cek Duplikat berdasarkan NIP/NIS
              const isExist = currentData.find(
                (d) => (type === "guru" ? d.nip : d.nisn) == uniqueKey
              );

              if (!isExist) {
                maxId++; // Naikkan ID
                if (type === "guru") {
                  newData.push({
                    id: maxId,
                    nip: String(nip),
                    nama: String(nama),
                    mapel: String(mapel),
                  });
                } else {
                  newData.push({
                    id: maxId,
                    nisn: String(nisn),
                    nama: String(nama),
                    kelas: String(kelas),
                    jk: String(jk),
                  });
                }
              } else {
                skippedCount++;
              }
            });

            if (newData.length === 0) {
              showToast(
                "Tidak ada data baru (Semua duplikat/invalid).",
                "warning"
              );
              input.value = "";
              return;
            }

            // Kirim ke Google Sheets
            showToast(`Mengunggah ${newData.length} data...`, "info");
            const res = await sendDataToSheets("add", type, newData);

            if (res.status === "success") {
              let msg = `Berhasil upload ${newData.length} data.`;
              if (skippedCount > 0)
                msg += ` ${skippedCount} duplikat dilewati.`;
              showToast(msg, "success");

              // Refresh tabel
              fetchDataFromSheets();
            } else {
              showToast("Gagal upload: " + res.message, "error");
            }
          } catch (error) {
            console.error(error);
            showToast("Gagal membaca file Excel.", "error");
          }
          // Reset input agar bisa pilih file sama lagi jika mau
          input.value = "";
        };
        reader.readAsArrayBuffer(file);
      }

      // Init
      window.onload = function () {
        fetchDataFromSheets();
      };

      function renderJurnalTable() {
        const tbody = document.querySelector("#table-jurnal tbody");
        tbody.innerHTML = "";

        // 1. Ambil Nilai Filter
        const fGuru = document.getElementById("filter-guru").value;
        const fMapel = document.getElementById("filter-mapel").value;
        const fKelas = document.getElementById("filter-kelas").value;
        const fBulan = document.getElementById("filter-bulan").value;

        // 2. Filter Data
        let filteredData = dataJurnal.filter((j) => {
          if (fGuru && j.guru !== fGuru) return false;
          if (fMapel && j.mapel !== fMapel) return false;
          if (fKelas && j.kelas !== fKelas) return false;
          if (fBulan && !j.tanggal.startsWith(fBulan)) return false; // Filter Bulan (YYYY-MM)
          return true;
        });

        // 3. Urutkan (Tanggal terbaru, lalu jam)
        const sortedJurnal = [...filteredData].sort(
          (a, b) =>
            new Date(b.tanggal) - new Date(a.tanggal) ||
            (a.jamke_mulai || a.jamke) - (b.jamke_mulai || b.jamke)
        );

        if (sortedJurnal.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="8" style="text-align:center; color:#888;">Tidak ada data ditemukan</td></tr>';
          return;
        }

        sortedJurnal.forEach((j) => {
          const tr = document.createElement("tr");
          // Format tanggal Indonesia (Contoh: 6 Januari 2026)
          const dateObj = new Date(j.tanggal);
          // Jika tanggal tidak valid, pakai nilai asli. Jika valid, format.
          const dateDisplay = isNaN(dateObj.getTime())
            ? j.tanggal
            : dateObj.toLocaleDateString("id-ID", {
                day: "numeric",
                month: "long",
                year: "numeric",
              });

          // Handle Legacy Data (yang belum punya jamke_mulai / jamke_sampai)
          // Prioritaskan jamke_mulai jika ada, jika tidak gunakan jamke
          const jamMulai = j.jamke_mulai || j.jamke;
          const jamSampai = j.jamke_sampai;

          // LOGIKA TAMPILAN JAM YANG DIPERBAIKI
          let jamDisplay = "";

          if (jamMulai && jamSampai) {
            // Jika ada mulai dan sampai
            if (jamMulai === jamSampai) {
              // Jika sama, tampilkan satu angka saja (biar tidak aneh: "2 - 2")
              jamDisplay = `${jamMulai}`;
            } else {
              // Tampilkan rentang
              jamDisplay = `${jamMulai} - ${jamSampai}`;
            }
          } else if (jamMulai) {
            // Hanya ada mulai (data lama atau inputan samping)
            jamDisplay = `${jamMulai}`;
          } else {
            jamDisplay = "-";
          }

          tr.innerHTML = `
      <td>${dateDisplay}</td>
      <td><span class="badge badge-L">${jamDisplay}</span></td>
      <td><strong>${j.guru}</strong></td>
      <td>
         <div style="font-weight:600">${j.kelas}</div>
         <small style="color:var(--text-muted)">${j.mapel}</small>
      </td>
      <td>${j.materi.substring(0, 30)}${j.materi.length > 30 ? "..." : ""}</td>
      <td><small>${j.tugas || "-"}</small></td>
      <td><small style="color:var(--danger)">${j.absensi || "-"}</small></td>
      <td style="text-align: right;">
        <button class="btn btn-info" onclick="editJurnal(${
          j.id
        })"><i class="fas fa-edit"></i></button>
        <button class="btn btn-danger" onclick="deleteJurnal(${
          j.id
        })"><i class="fas fa-trash"></i></button>
      </td>`;
          tbody.appendChild(tr);
        });
      }

      function openModalJurnal(isEdit = false) {
        document.getElementById("modal-jurnal").classList.add("open");

        // Isi Dropdown Guru (Hanya jika belum ada opsi, atau selalu refresh)
        const guruSelect = document.getElementById("jurnal-guru");
        guruSelect.innerHTML = '<option value="">-- Pilih Guru --</option>';
        dataGuru.forEach((g) => {
          guruSelect.innerHTML += `<option value="${g.nama}">${g.nama}</option>`;
        });

        // Isi Dropdown Filter Guru (Di Toolbar)
        const filterGuruSelect = document.getElementById("filter-guru");
        filterGuruSelect.innerHTML = '<option value="">Semua Guru</option>';
        dataGuru.forEach((g) => {
          filterGuruSelect.innerHTML += `<option value="${g.nama}">${g.nama}</option>`;
        });

        if (!isEdit) {
          document.getElementById("form-jurnal").reset();
          document.getElementById("jurnal-id").value = "";
          document.getElementById("modal-jurnal-title").innerText =
            "Tambah Jurnal";
          document.getElementById("jurnal-tanggal").valueAsDate = new Date();
        }
      }

      function closeModalJurnal() {
        document.getElementById("modal-jurnal").classList.remove("open");
      }

      async function saveJurnal(e) {
        e.preventDefault();

        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;

        const id = document.getElementById("jurnal-id").value;
        const guru = document.getElementById("jurnal-guru").value;
        const kelas = document.getElementById("jurnal-kelas").value;
        const mapel = document.getElementById("jurnal-mapel").value;

        // AMBIL VALUE BARU: jamke_mulai & jamke_sampai
        const jamkeMulai = document.getElementById("jurnal-jamke-mulai").value;
        const jamkeSampai = document.getElementById(
          "jurnal-jamke-sampai"
        ).value;

        const tanggal = document.getElementById("jurnal-tanggal").value;
        const materi = document.getElementById("jurnal-materi").value;
        const tugas = document.getElementById("jurnal-tugas").value;
        const absensi = document.getElementById("jurnal-absensi").value;

        submitBtn.disabled = true;
        submitBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Memproses...';

        let finalId = id;
        if (!finalId) {
          const maxId =
            dataJurnal.length > 0
              ? Math.max(...dataJurnal.map((d) => Number(d.id)))
              : 0;
          finalId = maxId + 1;
        }

        // Payload menyertakan field baru: jamke_mulai, jamke_sampai
        const payload = {
          id: finalId,
          guru,
          kelas,
          mapel,
          jamke_mulai: jamkeMulai,
          jamke_sampai: jamkeSampai,
          tanggal,
          materi,
          tugas,
          absensi,
        };
        const action = id ? "edit" : "add";

        try {
          const res = await sendDataToSheets(action, "jurnal", payload);

          if (res.status === "success") {
            showToast(id ? "Jurnal diperbarui" : "Jurnal ditambahkan");
            closeModalJurnal();
            fetchDataFromSheets();
          } else {
            showToast("Gagal: " + res.message, "error");
          }
        } catch (error) {
          console.error(error);
          showToast("Terjadi kesalahan koneksi", "error");
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalBtnText;
        }
      }

      function editJurnal(id) {
        const j = dataJurnal.find((d) => d.id == id);
        if (j) {
          document.getElementById("jurnal-id").value = j.id;
          document.getElementById("jurnal-kelas").value = j.kelas;
          document.getElementById("jurnal-tanggal").value = j.tanggal;
          document.getElementById("jurnal-materi").value = j.materi;
          document.getElementById("jurnal-tugas").value = j.tugas || "";
          document.getElementById("jurnal-absensi").value = j.absensi || "";

          // Handle Data Lama vs Data Baru
          // Jika ada jamke_mulai (baru), pakai itu. Jika tidak (lama), coba jamke.
          document.getElementById("jurnal-jamke-mulai").value =
            j.jamke_mulai || j.jamke;
          document.getElementById("jurnal-jamke-sampai").value =
            j.jamke_sampai || "";

          document.getElementById("modal-jurnal-title").innerText =
            "Edit Jurnal";

          openModalJurnal(true);

          // Set nilai setelah dropdown terisi
          document.getElementById("jurnal-guru").value = j.guru;
          document.getElementById("jurnal-mapel").value = j.mapel;
        }
      }

      async function deleteJurnal(id) {
        if (confirm("Yakin hapus jurnal ini?")) {
          const res = await sendDataToSheets("delete", "jurnal", { id });
          if (res.status === "success") {
            showToast("Data dihapus");
            fetchDataFromSheets();
          }
        }
      }

      function exportJurnalToExcel() {
        // Ambil data yang sudah terfilter dari fungsi render (atau ulangi logic filter di sini)
        // Untuk simplifikasi, kita pakai logika filter yang sama dengan renderJurnalTable
        const fGuru = document.getElementById("filter-guru").value;
        const fMapel = document.getElementById("filter-mapel").value;
        const fKelas = document.getElementById("filter-kelas").value;
        const fBulan = document.getElementById("filter-bulan").value;

        let filteredData = dataJurnal.filter((j) => {
          if (fGuru && j.guru !== fGuru) return false;
          if (fMapel && j.mapel !== fMapel) return false;
          if (fKelas && j.kelas !== fKelas) return false;
          if (fBulan && !j.tanggal.startsWith(fBulan)) return false;
          return true;
        });

        if (filteredData.length === 0) {
          showToast("Tidak ada data untuk diunduh", "warning");
          return;
        }

        // Mapping ke format Excel
        const dataExcel = filteredData.map((d) => ({
          Tanggal: d.tanggal,
          "Mulai Jam": d.jamke_mulai || d.jamke || "-", // Support data lama
          "Sampai Jam": d.jamke_sampai || "-",
          Guru: d.guru,
          Kelas: d.kelas,
          Mapel: d.mapel,
          "Kegiatan/Materi": d.materi,
          Penugasan: d.tugas,
          "Siswa Tidak Hadir": d.absensi,
        }));

        const ws = XLSX.utils.json_to_sheet(dataExcel);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Jurnal");

        // Nama file dinamis sesuai bulan atau sekarang
        const fileName = `Jurnal_Mengajar_${new Date()
          .toISOString()
          .slice(0, 10)}.xlsx`;
        XLSX.writeFile(wb, fileName);
        showToast("File Excel berhasil diunduh");
      }

      // --- LOGIKA ABSENSI ---

      // 1. Load Form (Generate Daftar Siswa berdasarkan Kelas)
      function loadPresensiForm() {
        const kelas = document.getElementById("absen-kelas").value;
        const container = document.getElementById("absen-input-container");

        // Cek apakah data siswa sudah terambil dari Sheets
        if (!dataSiswa || dataSiswa.length === 0) {
          container.innerHTML = `<div style="padding:20px; text-align:center; background:#fee2e2; color:#ef4444; border-radius:8px;">
        <i class="fas fa-exclamation-triangle"></i> Data Siswa belum dimuat. 
        <br>Klik menu Dashboard > Refresh Data, lalu coba lagi.
    </div>`;
          return;
        }

        if (!kelas) {
          showToast("Pilih kelas terlebih dahulu", "warning");
          return;
        }

        // Normalisasi teks (Hapus Spasi, Ubah Jadi Huruf Besar)
        const normalizeText = (text) => {
          return text ? text.toString().replace(/\s+/g, "").toUpperCase() : "";
        };

        const normalizedSelectedKelas = normalizeText(kelas);

        // Filter Siswa menggunakan teks yang sudah dinormalisasi
        const students = dataSiswa.filter((s) => {
          if (!s.kelas) return false;
          return normalizeText(s.kelas) === normalizedSelectedKelas;
        });

        if (students.length === 0) {
          container.innerHTML = `
      <div style="padding:40px; text-align:center; color: var(--text-muted); border: 2px dashed #e2e8f0; border-radius: 8px;">
        Tidak ada siswa ditemukan untuk kelas <b>${kelas}</b>.
      </div>`;
          return;
        }

        // Generate Tabel Input
        let html = `
    <table style="width:100%; border-collapse: collapse;">
      <thead>
        <tr style="background:#f8fafc;">
          <th style="padding:10px; text-align:left; border-bottom:2px solid #e2e8f0;">NISN</th>
          <th style="padding:10px; text-align:left; border-bottom:2px solid #e2e8f0;">Nama</th>
          <th style="padding:10px; text-align:center; border-bottom:2px solid #e2e8f0; color:var(--success);">Hadir</th>
          <th style="padding:10px; text-align:center; border-bottom:2px solid #e2e8f0; color:var(--warning);">Sakit</th>
          <th style="padding:10px; text-align:center; border-bottom:2px solid #e2e8f0; color:var(--info);">Izin</th>
          <th style="padding:10px; text-align:center; border-bottom:2px solid #e2e8f0; color:var(--danger);">Alpha</th>
        </tr>
      </thead>
      <tbody>
  `;

        students.forEach((s) => {
          html += `
      <tr data-nisn="${s.nisn}" data-nama="${s.nama}">
        <td style="padding:10px; border-bottom:1px solid #f1f5f9;">${s.nisn}</td>
        <td style="padding:10px; border-bottom:1px solid #f1f5f9; font-weight:600;">${s.nama}</td>
        <td style="text-align:center; border-bottom:1px solid #f1f5f9;">
          <input type="radio" name="absen_${s.nisn}" value="H" checked>
        </td>
        <td style="text-align:center; border-bottom:1px solid #f1f5f9;">
          <input type="radio" name="absen_${s.nisn}" value="S">
        </td>
        <td style="text-align:center; border-bottom:1px solid #f1f5f9;">
          <input type="radio" name="absen_${s.nisn}" value="I">
        </td>
        <td style="text-align:center; border-bottom:1px solid #f1f5f9;">
          <input type="radio" name="absen_${s.nisn}" value="A">
        </td>
      </tr>
    `;
        });

        html += `
      </tbody>
    </table>
    <div style="margin-top:20px; text-align:right;">
      <button class="btn btn-primary" onclick="savePresensi('${kelas}')">
        <i class="fas fa-save"></i> Simpan Presensi
      </button>
    </div>
  `;

        container.innerHTML = html;
      }

      // 2. Simpan Presensi (Versi Anti Error)
      async function savePresensi(kelas) {
        // Mapel sudah dropdown, ambil value-nya
        const mapel = document.getElementById("absen-mapel").value;
        const tanggalInput = document.getElementById("absen-tanggal").value;
        const rows = document.querySelectorAll(
          "#absen-input-container tbody tr"
        );

        if (!tanggalInput || !mapel) {
          showToast("Harap isi Tanggal dan Mapel", "error");
          return;
        }

        const attendanceData = [];
        const dateObj = new Date(tanggalInput);
        const hari = dateObj.toLocaleDateString("id-ID", { weekday: "long" });

        let currentId = 0;
        if (Array.isArray(dataPresensi) && dataPresensi.length > 0) {
          try {
            const ids = dataPresensi
              .map((d) => parseInt(d.id))
              .filter((id) => !isNaN(id));
            if (ids.length > 0) {
              currentId = Math.max(...ids);
            }
          } catch (err) {
            currentId = 0;
          }
        }

        rows.forEach((row) => {
          const nisn = row.getAttribute("data-nisn");
          const nama = row.getAttribute("data-nama");
          const status = row.querySelector(
            `input[name="absen_${nisn}"]:checked`
          ).value;

          currentId++;

          attendanceData.push({
            id: currentId,
            nisn: nisn,
            nama: nama,
            kelas: kelas,
            tanggal: tanggalInput,
            hari: hari,
            mapel: mapel, // Mapel sekarang dari dropdown
            status: status,
          });
        });

        try {
          showToast("Menyimpan presensi...", "info");
          const res = await sendDataToSheets("add", "presensi", attendanceData);

          if (res.status === "success") {
            showToast(
              `Berhasil menyimpan ${attendanceData.length} data presensi.`
            );
            dataPresensi = dataPresensi.concat(attendanceData);
            renderPresensiTable();
            document.getElementById("absen-mapel").value = "";
            document.getElementById(
              "absen-input-container"
            ).innerHTML = `<div style="padding:40px; text-align:center; color:var(--text-muted);">Data tersimpan. Klik Tampilkan Siswa lagi.</div>`;
          } else {
            showToast("Gagal: " + res.message, "error");
          }
        } catch (error) {
          console.error(error);
          showToast("Gagal menyimpan", "error");
        }
      }

      // 3. Render Tabel Rekap dengan Filter
      // 3. Render Tabel Rekap dengan Filter & Statistik
      // 3. Render Tabel Rekap dengan Filter & Statistik (Anti Error)
      function renderPresensiTable() {
        // PASTIKAN ELEMEN DITEMUKAN ATAU HENTIKAN FUNGSI
        const tbody = document.querySelector("#table-presensi tbody");
        const statsContainer = document.getElementById("rekap-stats");

        // --- TAMBAHAN ANTI ERROR ---
        if (!tbody) {
          console.error("Element table-presensi tbody tidak ditemukan!");
          return;
        }
        // -----------------------------

        tbody.innerHTML = "";
        if (statsContainer) statsContainer.innerHTML = "";

        // Ambil Nilai Filter
        // Pastikan ID filter sama dengan HTML: rekap-kelas, rekap-mapel, rekap-bulan
        const fKelas = document.getElementById("rekap-kelas");
        const fMapel = document.getElementById("rekap-mapel");
        const fBulan = document.getElementById("rekap-bulan");

        let valKelas = fKelas ? fKelas.value : "";
        let valMapel = fMapel ? fMapel.value : "";
        let valBulan = fBulan ? fBulan.value : "";

        // Filter Data
        let filteredData = dataPresensi.filter((p) => {
          if (valKelas && p.kelas !== valKelas) return false;
          if (valMapel && p.mapel !== valMapel) return false;
          if (valBulan && !p.tanggal.startsWith(valBulan)) return false;
          return true;
        });

        // --- LOGIKA BARU: HITUNG KEHADIRAN EFEKTIF ---
        // 1. Cek apakah siswa H di hari yang sama
        let effectiveHadirMap = {}; // Key: "nisn_tanggal", Value: true

        filteredData.forEach((p) => {
          const key = `${p.nisn}_${p.tanggal}`;
          if (p.status === "H") {
            effectiveHadirMap[key] = true;
          }
        });

        // 2. Hitung Statistik Global & Per Siswa
        let totalH = 0,
          totalS = 0,
          totalI = 0,
          totalA = 0;
        let studentStats = {}; // key: nisn, value: { total: 0, hadir: 0 }

        filteredData.forEach((p) => {
          const key = `${p.nisn}_${p.tanggal}`;

          // Cek apakah di tanggal itu ada status H di mapel lain?
          let effectiveStatus = effectiveHadirMap[key] ? "H" : p.status;

          // Hitung Global
          if (effectiveStatus === "H") totalH++;
          else if (effectiveStatus === "S") totalS++;
          else if (effectiveStatus === "I") totalI++;
          else if (effectiveStatus === "A") totalA++;

          // Hitung Per Siswa
          if (!studentStats[p.nisn])
            studentStats[p.nisn] = { total: 0, hadir: 0 };
          studentStats[p.nisn].total++;
          if (effectiveStatus === "H") studentStats[p.nisn].hadir++;
        });

        // Tampilkan Kartu Statistik di Atas Tabel (Style Dashboard)
        if (statsContainer && filteredData.length > 0) {
          statsContainer.style.display = "grid";
          statsContainer.innerHTML = `
      <div class="stat-card">
        <div class="stat-info"><h3>${totalH}</h3><p>Total Hadir</p></div>
        <div class="stat-icon bg-green-light"><i class="fas fa-check-circle"></i></div>
      </div>
      <div class="stat-card">
        <div class="stat-info"><h3>${totalS}</h3><p>Total Sakit</p></div>
        <div class="stat-icon bg-orange-light"><i class="fas fa-procedures"></i></div>
      </div>
      <div class="stat-card">
        <div class="stat-info"><h3>${totalI}</h3><p>Total Izin</p></div>
        <div class="stat-icon bg-blue-light"><i class="fas fa-envelope-open-text"></i></div>
      </div>
      <div class="stat-card">
        <div class="stat-info"><h3>${totalA}</h3><p>Total Alpha</p></div>
        <div class="stat-icon bg-red-light"><i class="fas fa-user-times"></i></div>
      </div>
    `;
        } else if (statsContainer) {
          statsContainer.style.display = "none";
        }
        // ----------------------------------------------------

        // Urutkan (Tanggal terbaru)
        const sortedData = [...filteredData].sort(
          (a, b) => new Date(b.tanggal) - new Date(a.tanggal)
        );

        if (sortedData.length === 0) {
          tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;">Tidak ada data ditemukan</td></tr>`;
          return;
        }

        sortedData.forEach((p, index) => {
          let statusStyle = "color:var(--success)";
          if (p.status === "S") statusStyle = "color:var(--warning)";
          if (p.status === "I") statusStyle = "color:var(--info)";
          if (p.status === "A") statusStyle = "color:var(--danger)";

          // Format Tanggal
          const dateObj = new Date(p.tanggal);
          const dateDisplay = isNaN(dateObj.getTime())
            ? p.tanggal
            : dateObj.toLocaleDateString("id-ID", {
                day: "numeric",
                month: "long",
                year: "numeric",
              });

          // Hitung Persentase
          const sData = studentStats[p.nisn];
          const persen = sData
            ? ((sData.hadir / sData.total) * 100).toFixed(1)
            : "0";

          let persenColor = "color:var(--success)";
          if (persen < 90) persenColor = "color:var(--warning)";
          if (persen < 70) persenColor = "color:var(--danger)";

          const tr = document.createElement("tr");
          tr.innerHTML = `
      <td>${index + 1}</td>
      <td><span class="badge badge-L">${p.kelas}</span></td>
      <td>${p.nisn}</td>
      <td><strong>${p.nama}</strong></td>
      <td>
        <div>${p.hari}</div>
        <small style="color:var(--text-muted)">${dateDisplay}</small>
      </td>
      <td>${p.mapel}</td>
      <td><strong style="${statusStyle}">${p.status}</strong></td>
      
      <!-- KOLOM BARU: PERSENTASE -->
      <td><strong style="${persenColor}">${persen}%</strong></td>
      
      <td style="text-align: right;">
        <button class="btn btn-info" onclick="editPresensi(${
          p.id
        })"><i class="fas fa-edit"></i></button>
        <button class="btn btn-danger" onclick="deletePresensi(${
          p.id
        })"><i class="fas fa-trash"></i></button>
      </td>`;
          tbody.appendChild(tr);
        });
      }
      // 4. Download Excel Rekap
      function downloadPresensiToExcel() {
        // Ambil data terfilter (logika sama dengan render)
        const fKelas = document.getElementById("rekap-kelas").value;
        const fMapel = document.getElementById("rekap-mapel").value;
        const fBulan = document.getElementById("rekap-bulan").value;

        let filteredData = dataPresensi.filter((p) => {
          if (fKelas && p.kelas !== fKelas) return false;
          if (fMapel && p.mapel !== fMapel) return false;
          if (fBulan && !p.tanggal.startsWith(fBulan)) return false;
          return true;
        });

        if (filteredData.length === 0) {
          showToast("Tidak ada data untuk diunduh", "warning");
          return;
        }

        const dataExcel = filteredData.map((d) => ({
          No: filteredData.indexOf(d) + 1,
          NISN: d.nisn,
          "Nama Siswa": d.nama,
          Kelas: d.kelas,
          Hari: d.hari,
          Tanggal: d.tanggal,
          "Mata Pelajaran": d.mapel,
          Status: d.status,
        }));

        const ws = XLSX.utils.json_to_sheet(dataExcel);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Rekap");
        const fileName = `Rekap_Presensi_${new Date()
          .toISOString()
          .slice(0, 10)}.xlsx`;
        XLSX.writeFile(wb, fileName);
        showToast("Berhasil download rekap");
      }

      // 5. Edit Presensi
      function editPresensi(id) {
        const p = dataPresensi.find((d) => d.id == id);
        if (p) {
          document.getElementById("edit-presensi-id").value = p.id;
          document.getElementById("edit-presensi-nama").value = p.nama;
          document.getElementById("edit-presensi-kelas").value = p.kelas;
          document.getElementById("edit-presensi-tanggal").value = p.tanggal;
          document.getElementById("edit-presensi-mapel").value = p.mapel;
          document.getElementById("edit-presensi-status").value = p.status;

          openModal("modal-presensi");
        }
      }

      // Simpan Perubahan (Update)
      async function updatePresensi(e) {
        e.preventDefault();
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;

        const id = document.getElementById("edit-presensi-id").value;
        const tanggal = document.getElementById("edit-presensi-tanggal").value;
        const mapel = document.getElementById("edit-presensi-mapel").value;
        const status = document.getElementById("edit-presensi-status").value;

        // Hitung Hari berdasarkan tanggal baru
        const dateObj = new Date(tanggal);
        const hari = dateObj.toLocaleDateString("id-ID", { weekday: "long" });

        // Cari data lama untuk melengkapi payload yang tidak diubah (nisn, nama, dll)
        const oldData = dataPresensi.find((d) => d.id == id);

        const payload = {
          id: id,
          nisn: oldData.nisn,
          nama: oldData.nama,
          kelas: oldData.kelas,
          tanggal: tanggal,
          hari: hari,
          mapel: mapel,
          status: status,
        };

        submitBtn.disabled = true;
        submitBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Memproses...';

        try {
          const res = await sendDataToSheets("edit", "presensi", payload);
          if (res.status === "success") {
            showToast("Data presensi diperbarui");
            closeModal("modal-presensi");
            fetchDataFromSheets(); // Refresh data
          } else {
            showToast("Gagal: " + res.message, "error");
          }
        } catch (error) {
          console.error(error);
          showToast("Terjadi kesalahan", "error");
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalBtnText;
        }
      }

      // 6. Hapus Presensi
      async function deletePresensi(id) {
        if (confirm("Hapus data presensi ini?")) {
          const res = await sendDataToSheets("delete", "presensi", { id });
          if (res.status === "success") {
            showToast("Data dihapus");
            fetchDataFromSheets();
          }
        }
      }

      //

      // --- LOGIKA NILAI (MENU BARU) ---
      function renderNilaiTable() {
        const tbody = document.querySelector("#table-nilai tbody");
        tbody.innerHTML = "";

        const fKelas = document.getElementById("filter-nilai-kelas").value;
        const fMapel = document.getElementById("filter-nilai-mapel").value;

        const filtered = dataNilai.filter((n) => {
          if (fKelas && n.kelas !== fKelas) return false;
          if (fMapel && n.mapel !== fMapel) return false;
          return true;
        });

        if (filtered.length === 0) {
          tbody.innerHTML = `<tr><td colspan="15" style="text-align:center">Tidak ada data nilai</td></tr>`;
          return;
        }

        filtered.forEach((n) => {
          const tr = document.createElement("tr");
          // Generate Cells N1-N10
          let nilaiCells = "";
          for (let i = 1; i <= 10; i++) {
            let val = n[`n${i}`] || "";
            val =
              val !== "" ? `<span class="badge badge-L">${val}</span>` : "-";
            nilaiCells += `<td>${val}</td>`;
          }

          // Format Rata-rata
          const rata = parseFloat(n.rata_rata).toFixed(2);

          tr.innerHTML = `
                <td><strong>${n.nama}</strong><br><small style="color:#888">${n.nisn}</small></td>
                <td>${n.kelas}</td>
                <td>${n.mapel}</td>
                ${nilaiCells}
                <td style="background:#eff6ff; font-weight:bold;">${rata}</td>
                <td style="text-align:right">
                    <button class="btn btn-info" onclick="editNilai(${n.id})"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-danger" onclick="deleteNilai(${n.id})"><i class="fas fa-trash"></i></button>
                </td>
            `;
          tbody.appendChild(tr);
        });
      }

      // --- FUNGSI BARU: Filter Siswa Berdasarkan Kelas ---
      function filterSiswaByKelas() {
        const selectedKelas = document.getElementById("nilai-kelas").value;
        const selNama = document.getElementById("nilai-nisn");

        // Reset dropdown nama
        selNama.innerHTML = '<option value="">-- Pilih Siswa --</option>';

        if (!selectedKelas) return; // Jika kelas belum dipilih, stop di sini

        // Filter data siswa sesuai kelas yang dipilih
        const filteredSiswa = dataSiswa.filter(
          (s) => s.kelas === selectedKelas
        );

        // Isi dropdown nama (menggunakan teknik cepat map/join)
        const options = filteredSiswa
          .map((s) => `<option value="${s.nisn}">${s.nama}</option>`)
          .join("");

        selNama.innerHTML += options;
      }

      // --- UPDATE: Open Modal Nilai ---
      function openModalNilai() {
        document.getElementById("modal-nilai").classList.add("open");
        document.getElementById("form-nilai").reset();
        document.getElementById("nilai-id").value = "";
        document.getElementById("nilai-rata-display").innerText = "0";

        // 1. Ambil daftar Kelas Unik dari Data Siswa (Agar fleksibel)
        // Menggunakan Set untuk menghapus duplikat kelas
        const uniqueKelas = [...new Set(dataSiswa.map((s) => s.kelas))].sort();

        // 2. Isi Dropdown Kelas
        const selKelas = document.getElementById("nilai-kelas");
        // Buat opsi HTML dengan cepat
        // const kelasOptions = uniqueKelas
        //   .map((k) => `<option value="${k}">${k}</option>`)
        //   .join("");
        // selKelas.innerHTML =
        //   '<option value="">-- Pilih Kelas --</option>' + kelasOptions;

        // 3. Reset Dropdown Nama Siswa
        document.getElementById("nilai-nisn").innerHTML =
          '<option value="">-- Pilih Kelas Terlebih Dahulu --</option>';
      }

      // --- UPDATE: Save Nilai ---
      // Kita perlu sedikit menyesuaikan fungsi saveNilai agar membaca kelas dari dropdown, bukan dari auto-fill.
      async function saveNilai(e) {
        e.preventDefault();

        // Ambil elemen tombol loading (kode perbaikan sebelumnya)
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Memproses...';

        const id = document.getElementById("nilai-id").value;
        const nisn = document.getElementById("nilai-nisn").value;
        const kelas = document.getElementById("nilai-kelas").value; // Ambil kelas dari dropdown
        const siswa = dataSiswa.find((s) => s.nisn == nisn);

        let payload = {
          nisn: nisn,
          nama: siswa ? siswa.nama : "-", // Cek keamanan jika siswa null
          kelas: kelas, // Langsung ambil dari dropdown kelas
          mapel: document.getElementById("nilai-mapel").value,
          rata_rata: hitungRataRataModal(),
        };

        for (let i = 1; i <= 10; i++) {
          payload[`n${i}`] = document.getElementById(`nilai-n${i}`).value;
        }

        let finalId = id;
        if (!finalId)
          finalId = dataNilai.length
            ? Math.max(...dataNilai.map((d) => d.id)) + 1
            : 1;
        payload.id = finalId;

        try {
          const res = await sendDataToSheets(
            id ? "edit" : "add",
            "nilai",
            payload
          );
          if (res.status === "success") {
            showToast("Nilai tersimpan");
            closeModal("modal-nilai");
            fetchDataFromSheets();
          } else {
            showToast("Gagal: " + res.message, "error");
          }
        } catch (error) {
          console.error(error);
          showToast("Terjadi kesalahan koneksi", "error");
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalBtnText;
        }
      }

      function autoFillKelasFromNilai() {
        const nisn = document.getElementById("nilai-nisn").value;
        const siswa = dataSiswa.find((s) => s.nisn == nisn);
        if (siswa) document.getElementById("nilai-kelas").value = siswa.kelas;
      }

      function hitungRataRataModal() {
        let total = 0;
        let count = 0;
        for (let i = 1; i <= 10; i++) {
          const val = document.getElementById(`nilai-n${i}`).value;
          if (val !== "" && !isNaN(val)) {
            total += parseFloat(val);
            count++;
          }
        }
        const rata = count > 0 ? (total / count).toFixed(2) : 0;
        document.getElementById("nilai-rata-display").innerText = rata;
        return rata;
      }

      function editNilai(id) {
        const n = dataNilai.find((d) => d.id == id);
        if (n) {
          openModalNilai();
          document.getElementById("nilai-id").value = n.id;
          document.getElementById("nilai-nisn").value = n.nisn;
          autoFillKelasFromNilai();
          document.getElementById("nilai-mapel").value = n.mapel;

          // Isi N1-N10
          for (let i = 1; i <= 10; i++) {
            document.getElementById(`nilai-n${i}`).value = n[`n${i}`] || "";
          }
          hitungRataRataModal();
        }
      }

      async function deleteNilai(id) {
        if (confirm("Hapus nilai ini?")) {
          const res = await sendDataToSheets("delete", "nilai", { id });
          if (res.status === "success") fetchDataFromSheets();
        }
      }

      function exportNilaiToExcel() {
        // Filter Logic Sama dengan Render
        const fKelas = document.getElementById("filter-nilai-kelas").value;
        const fMapel = document.getElementById("filter-nilai-mapel").value;
        const filtered = dataNilai.filter((n) => {
          if (fKelas && n.kelas !== fKelas) return false;
          if (fMapel && n.mapel !== fMapel) return false;
          return true;
        });

        if (filtered.length === 0)
          return showToast("Tidak ada data", "warning");

        const dataExcel = filtered.map((d) => ({
          NISN: d.nisn,
          Nama: d.nama,
          Kelas: d.kelas,
          Mapel: d.mapel,
          N1: d.n1,
          N2: d.n2,
          N3: d.n3,
          N4: d.n4,
          N5: d.n5,
          N6: d.n6,
          N7: d.n7,
          N8: d.n8,
          N9: d.n9,
          N10: d.n10,
          "Rata-rata": d.rata_rata,
        }));

        const ws = XLSX.utils.json_to_sheet(dataExcel);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Nilai");
        XLSX.writeFile(
          wb,
          `Nilai_Siswa_${new Date().toISOString().slice(0, 10)}.xlsx`
        );
      }
    </script>
  </body>
</html>
